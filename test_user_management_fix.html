<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test User Management API Fix</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            .result {
                padding: 10px;
                margin: 10px 0;
                border-radius: 5px;
            }
            .success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            button {
                background: #007cba;
                color: white;
                padding: 10px 20px;
                border: none;
                cursor: pointer;
                margin: 5px;
            }
            pre {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 4px;
                overflow-x: auto;
            }
        </style>
    </head>
    <body>
        <h1>Test User Management API Fix</h1>
        <p>
            This tests the fix for the "Column not found: deleted_at" error in
            UserRequest queries.
        </p>

        <button onclick="testUsersAPI()">Test Users API</button>
        <button onclick="testStatsOnly()">Test Stats Only</button>

        <div id="results"></div>

        <script>
            async function testUsersAPI() {
                const resultsDiv = document.getElementById("results");
                resultsDiv.innerHTML =
                    '<div class="info">Testing /admin/api/users endpoint...</div>';

                try {
                    const response = await fetch("/admin/api/users", {
                        method: "GET",
                        headers: {
                            Accept: "application/json",
                            "X-Requested-With": "XMLHttpRequest",
                        },
                    });

                    const data = await response.json();

                    if (response.ok && !data.error) {
                        resultsDiv.innerHTML = `
                        <div class="success">✅ Users API working successfully!</div>
                        <div class="info">
                            <strong>Stats:</strong><br>
                            • Total Users: ${data.stats?.total || 0}<br>
                            • Active Users: ${data.stats?.active || 0}<br>
                            • Total Connections: ${
                                data.stats?.total_connections || 0
                            }<br>
                            • Users with Connections: ${
                                data.stats?.users_with_connections || 0
                            }
                        </div>
                        <div class="info">
                            <strong>Response:</strong>
                            <pre>${JSON.stringify(data, null, 2).substring(
                                0,
                                1000
                            )}...</pre>
                        </div>
                    `;
                    } else {
                        resultsDiv.innerHTML = `
                        <div class="error">❌ API Error: ${
                            data.error || "Unknown error"
                        }</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `
                    <div class="error">❌ Network Error: ${error.message}</div>
                `;
                }
            }

            async function testStatsOnly() {
                const resultsDiv = document.getElementById("results");
                resultsDiv.innerHTML =
                    '<div class="info">Testing just the stats calculation...</div>';

                try {
                    // This simulates what the stats calculation would look like
                    const response = await fetch(
                        "/admin/api/users?stats_only=1",
                        {
                            method: "GET",
                            headers: {
                                Accept: "application/json",
                                "X-Requested-With": "XMLHttpRequest",
                            },
                        }
                    );

                    const data = await response.json();

                    if (response.ok) {
                        resultsDiv.innerHTML = `
                        <div class="success">✅ Stats calculation successful!</div>
                        <div class="info">The 'deleted_at' column issue has been resolved.</div>
                    `;
                    } else {
                        resultsDiv.innerHTML = `
                        <div class="error">❌ Stats Error: ${
                            data.error || "Unknown error"
                        }</div>
                    `;
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `
                    <div class="error">❌ Error: ${error.message}</div>
                `;
                }
            }
        </script>
    </body>
</html>
